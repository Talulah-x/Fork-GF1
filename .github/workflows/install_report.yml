name: Build Report

on:
  workflow_dispatch:
    inputs:
      build_tag:
        description: 'Build tag from install workflow'
        required: true
        type: string
      build_run_id:
        description: 'Run ID of the install workflow'
        required: true
        type: string
      is_release:
        description: 'Whether this is a release build'
        required: true
        type: string
      trigger_event:
        description: 'Event that triggered the build'
        required: true
        type: string

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get detailed dependency information
        id: deps_info
        run: |
          echo "Collecting detailed dependency information..."
          
          # MaaFramework info
          maa_response=$(curl -sX GET "https://api.github.com/repos/MaaXYZ/MaaFramework/releases" --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}')
          maa_stable=$(echo "$maa_response" | jq -r '.[] | select(.prerelease == false) | select(.draft == false) | .tag_name' | head -1)
          
          if [[ -z "$maa_stable" || "$maa_stable" == "null" ]]; then
            maa_latest_response=$(curl -sX GET "https://api.github.com/repos/MaaXYZ/MaaFramework/releases/latest" --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}')
            maa_tag=$(echo "$maa_latest_response" | jq -r '.tag_name // "unknown"')
            maa_date=$(echo "$maa_latest_response" | jq -r '.published_at // "unknown"')
            maa_url=$(echo "$maa_latest_response" | jq -r '.html_url // "unknown"')
            maa_prerelease=$(echo "$maa_latest_response" | jq -r '.prerelease // false')
          else
            maa_release_response=$(curl -sX GET "https://api.github.com/repos/MaaXYZ/MaaFramework/releases/tags/$maa_stable" --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}')
            maa_tag=$(echo "$maa_release_response" | jq -r '.tag_name // "unknown"')
            maa_date=$(echo "$maa_release_response" | jq -r '.published_at // "unknown"')
            maa_url=$(echo "$maa_release_response" | jq -r '.html_url // "unknown"')
            maa_prerelease=$(echo "$maa_release_response" | jq -r '.prerelease // false')
          fi
          
          # MFAAvalonia info
          mfa_response=$(curl -sX GET "https://api.github.com/repos/MaaGF1/MFAAvalonia/releases/latest" --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}')
          mfa_tag=$(echo "$mfa_response" | jq -r '.tag_name // "No releases"')
          mfa_date=$(echo "$mfa_response" | jq -r '.published_at // "N/A"')
          mfa_url=$(echo "$mfa_response" | jq -r '.html_url // ""')
          mfa_prerelease=$(echo "$mfa_response" | jq -r '.prerelease // false')
          
          # Output all variables
          echo "maa_tag=$maa_tag" >> $GITHUB_OUTPUT
          echo "maa_date=$maa_date" >> $GITHUB_OUTPUT
          echo "maa_url=$maa_url" >> $GITHUB_OUTPUT
          echo "maa_prerelease=$maa_prerelease" >> $GITHUB_OUTPUT
          echo "mfa_tag=$mfa_tag" >> $GITHUB_OUTPUT
          echo "mfa_date=$mfa_date" >> $GITHUB_OUTPUT
          echo "mfa_url=$mfa_url" >> $GITHUB_OUTPUT
          echo "mfa_prerelease=$mfa_prerelease" >> $GITHUB_OUTPUT

      - name: Generate comprehensive build report
        run: |
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Generate main build summary for GitHub Actions page
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          # ðŸ“Š Comprehensive Build Report
          
          ## ðŸ—ï¸ Build Overview
          
          | Property | Value |
          |----------|-------|
          | **Build Tag** | `${{ inputs.build_tag }}` |
          | **Build Run** | [#${{ inputs.build_run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }}) |
          | **Is Release** | ${{ inputs.is_release == 'true' && 'âœ… Release Build' || 'ðŸ”§ CI Build' }} |
          | **Triggered By** | `${{ inputs.trigger_event }}` |
          | **Report Generated** | `BUILD_DATE_PLACEHOLDER` |
          
          ## ðŸ“¦ Dependency Analysis
          
          ### MaaFramework Status
          
          | Property | Value |
          |----------|-------|
          | **Repository** | [MaaXYZ/MaaFramework](https://github.com/MaaXYZ/MaaFramework) |
          | **Version Used** | [${{ steps.deps_info.outputs.maa_tag }}](${{ steps.deps_info.outputs.maa_url }}) |
          | **Release Date** | `${{ steps.deps_info.outputs.maa_date }}` |
          | **Type** | ${{ steps.deps_info.outputs.maa_prerelease == 'true' && 'ðŸš§ Pre-release' || 'âœ… Stable' }} |
          
          ### MFAAvalonia Status
          
          | Property | Value |
          |----------|-------|
          | **Repository** | [MaaGF1/MFAAvalonia](https://github.com/MaaGF1/MFAAvalonia) |
          | **Version Used** | MFA_VERSION_PLACEHOLDER |
          | **Release Date** | `${{ steps.deps_info.outputs.mfa_date }}` |
          | **Type** | ${{ steps.deps_info.outputs.mfa_prerelease == 'true' && 'ðŸš§ Pre-release' || 'âœ… Stable' }} |
          
          ## ðŸ Python Environment
          
          | Package | Version | Purpose |
          |---------|---------|---------|
          | **Python** | `3.11` | Runtime environment |
          | **pyinstaller** | `Latest` | Application packaging |
          | **MaaFw** | `Latest` | Core framework bindings |
          | **Pillow** | `Latest` | Image processing |
          | **numpy** | `Latest` | Numerical computations |
          | **requests** | `Latest` | HTTP client library |
          | **pywin32** | `Latest` | Windows API access |
          | **pygetwindow** | `Latest` | Window management utilities |
          
          ## ðŸŽ¯ Build Targets
          
          | Architecture | Status |
          |--------------|--------|
          | **x86_64** | âœ… Configured |
          | **aarch64** | âœ… Configured |
          
          ## ðŸ”— Related Links
          
          - [ðŸ“‹ Original Build Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }})
          - [ðŸ  Source Repository](https://github.com/${{ github.repository }})
          - [ðŸ”§ MaaFramework Releases](https://github.com/MaaXYZ/MaaFramework/releases)
          - [ðŸ–¥ï¸ MFAAvalonia Releases](https://github.com/MaaGF1/MFAAvalonia/releases)
          
          ${{ inputs.is_release == 'true' && '## ðŸŽ‰ Release Information' || '## ðŸ”§ Development Build' }}
          
          ${{ inputs.is_release == 'true' && 'This build will be published to GitHub Releases automatically.' || 'This is a development build. Artifacts are available for download from the workflow run.' }}
          
          ---
          
          *ðŸ“… Report generated on BUILD_DATE_PLACEHOLDER | ðŸ¤– Automated by GitHub Actions*
          SUMMARY_EOF
          
          # Replace placeholders
          sed -i "s/BUILD_DATE_PLACEHOLDER/${BUILD_DATE}/g" $GITHUB_STEP_SUMMARY
          
          # Handle MFA version link
          if [[ -n "${{ steps.deps_info.outputs.mfa_url }}" && "${{ steps.deps_info.outputs.mfa_url }}" != "" ]]; then
            sed -i "s|MFA_VERSION_PLACEHOLDER|[${{ steps.deps_info.outputs.mfa_tag }}](${{ steps.deps_info.outputs.mfa_url }})|g" $GITHUB_STEP_SUMMARY
          else
            sed -i "s/MFA_VERSION_PLACEHOLDER/${{ steps.deps_info.outputs.mfa_tag }}/g" $GITHUB_STEP_SUMMARY
          fi

      - name: Create detailed report file
        run: |
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Create a detailed markdown report
          cat > DETAILED_BUILD_REPORT.md << 'EOF'
          # Detailed Build Report
          
          ## Build Summary
          
          This report provides comprehensive information about the build process, dependencies, and artifacts generated.
          
          ### Build Information
          
          | Property | Value |
          |----------|-------|
          | **Build Tag** | `${{ inputs.build_tag }}` |
          | **Build Run ID** | `${{ inputs.build_run_id }}` |
          | **Build Type** | ${{ inputs.is_release == 'true' && 'Release Build' || 'Development/CI Build' }} |
          | **Trigger Event** | `${{ inputs.trigger_event }}` |
          | **Build Date** | `BUILD_DATE_PLACEHOLDER` |
          | **Repository** | [${{ github.repository }}](https://github.com/${{ github.repository }}) |
          
          ### Dependencies Used
          
          #### MaaFramework
          
          - **Repository**: [MaaXYZ/MaaFramework](https://github.com/MaaXYZ/MaaFramework)
          - **Version**: [${{ steps.deps_info.outputs.maa_tag }}](${{ steps.deps_info.outputs.maa_url }})
          - **Release Date**: `${{ steps.deps_info.outputs.maa_date }}`
          - **Type**: ${{ steps.deps_info.outputs.maa_prerelease == 'true' && 'Pre-release' || 'Stable Release' }}
          - **Purpose**: Core automation framework providing the main functionality
          
          #### MFAAvalonia UI Framework
          
          - **Repository**: [MaaGF1/MFAAvalonia](https://github.com/MaaGF1/MFAAvalonia)
          - **Version**: MFA_VERSION_PLACEHOLDER
          - **Release Date**: `${{ steps.deps_info.outputs.mfa_date }}`
          - **Type**: ${{ steps.deps_info.outputs.mfa_prerelease == 'true' && 'Pre-release' || 'Stable Release' }}
          - **Purpose**: User interface framework built with Avalonia UI
          
          ### Python Dependencies
          
          The following Python packages are included in the build:
          
          | Package | Purpose | Installation Command |
          |---------|---------|---------------------|
          | `pyinstaller` | Packages Python applications into executables | `pip install pyinstaller` |
          | `MaaFw` | Python bindings for MaaFramework | `pip install MaaFw` |
          | `Pillow` | Python Imaging Library for image processing | `pip install Pillow` |
          | `numpy` | Numerical computing library | `pip install numpy` |
          | `requests` | HTTP library for API calls | `pip install requests` |
          | `pywin32` | Windows-specific functionality | `pip install pywin32` |
          | `pygetwindow` | Cross-platform window management | `pip install pygetwindow` |
          
          ### Build Targets
          
          This build supports the following architectures:
          
          - **x86_64**: 64-bit Intel/AMD processors (most common)
          - **aarch64**: 64-bit ARM processors (ARM64, Apple Silicon, etc.)
          
          ### Artifact Information
          
          The build produces the following artifacts:
          
          1. **Application Executable**: Main program file
          2. **Dependencies**: Required libraries and frameworks
          3. **Configuration Files**: Application settings and configurations
          4. **Build Information**: Version and build details
          
          ### Quality Assurance
          
          - âœ… **Dependency Verification**: All dependencies are verified and downloaded from official sources
          - âœ… **Version Pinning**: MaaFramework uses stable releases when available
          - âœ… **Multi-Architecture**: Builds are tested on multiple processor architectures
          - âœ… **Automated Testing**: Build process is fully automated and reproducible
          
          ### Links and Resources
          
          - [Build Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }})
          - [Source Code Repository](https://github.com/${{ github.repository }})
          - [MaaFramework Documentation](https://github.com/MaaXYZ/MaaFramework)
          - [MFAAvalonia Project](https://github.com/MaaGF1/MFAAvalonia)
          
          ---
          
          *This report was automatically generated on BUILD_DATE_PLACEHOLDER by the GitHub Actions build system.*
          EOF
          
          # Replace placeholders
          sed -i "s/BUILD_DATE_PLACEHOLDER/${BUILD_DATE}/g" DETAILED_BUILD_REPORT.md
          
          # Handle MFA version link
          if [[ -n "${{ steps.deps_info.outputs.mfa_url }}" && "${{ steps.deps_info.outputs.mfa_url }}" != "" ]]; then
            sed -i "s|MFA_VERSION_PLACEHOLDER|[${{ steps.deps_info.outputs.mfa_tag }}](${{ steps.deps_info.outputs.mfa_url }})|g" DETAILED_BUILD_REPORT.md
          else
            sed -i "s/MFA_VERSION_PLACEHOLDER/${{ steps.deps_info.outputs.mfa_tag }}/g" DETAILED_BUILD_REPORT.md
          fi
          
          echo "âœ… Detailed build report generated: DETAILED_BUILD_REPORT.md"

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ inputs.build_tag }}
          path: DETAILED_BUILD_REPORT.md
          retention-days: 90

      - name: Comment on source workflow (if applicable)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            // This step could be enhanced to post comments on the original workflow
            console.log('Build report generated for run ID: ${{ inputs.build_run_id }}');
            console.log('Report available at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}');